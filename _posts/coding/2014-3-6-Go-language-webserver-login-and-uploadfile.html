
---
layout: post
title: Go语言实现web服务器，登陆和文件上传
category: coding
tags:golang
keywords:golang,web server
tagline: Supporting tagline
---

<body>
<h1 id="go-web-">Go语言实现web服务器，登陆和文件上传</h1>
<p>学习使用Go语言实现一个web服务器，编写登陆页面，上传文件页面，实现简单登陆验证和文件上传功能</p>
<h2 id="web-">web服务器</h2>
<pre><code>func sayhelloName(w http.ResponseWriter, r *http.Request) {
    r.ParseForm()       //解析url传递的参数，对于POST则解析响应包的主体（request body）
    //注意:如果没有调用ParseForm方法，下面无法获取表单的数据
    fmt.Println(r.Form) //这些信息是输出到服务器端的打印信息
    fmt.Println(&quot;path&quot;, r.URL.Path)
    fmt.Println(&quot;scheme&quot;, r.URL.Scheme)
    fmt.Println(r.Form[&quot;url_long&quot;])
    for k, v := range r.Form {
        fmt.Println(&quot;key:&quot;, k)
        fmt.Println(&quot;val:&quot;, strings.Join(v, &quot;&quot;))
    }
    fmt.Fprintf(w, &quot;Hello swinghu!&quot;) //这个写入到w的是输出到客户端的
}</code></pre>
<p>启动该页面的处理函数</p>
<pre><code>    main（）{
          http.HandleFunc(&quot;/&quot;, sayhelloName)       //设置访问的路由
        err := http.ListenAndServe(&quot;:9090&quot;, nil) //设置监听的端口
        if err != nil {
            log.Fatal(&quot;ListenAndServe: &quot;, err)
        }
    }</code></pre>
<p>浏览器输入127.0.0.1,查看结果：<br><img src="http://i.imgur.com/WIRrOcq.png" alt=""></p>
<h2 id="-">登陆页面设计</h2>
<p>Notepad++ 编写html文件并保存为login.gptl(以下github自动将html转换为网页显示)    </p>
<blockquote>
<pre><code>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;table weith=&quot;1024&quot; heigth=&quot;400&quot;&gt;
    &lt;input type=&quot;checkbox&quot; name = &quot;interest&quot; value = &quot;football&quot;&gt;足球
    &lt;input type=&quot;checkbox&quot; name = &quot;interest&quot; value= &quot;basketball&quot;&gt;篮球
    &lt;input type=&quot;checkbox&quot; name = &quot;interest&quot; value =&quot;tennis&quot;&gt;网球
    &lt;form action=&quot;/login&quot; method=&quot;post&quot;&gt;
        用户名:&lt;input type=&quot;text&quot; name=&quot;username&quot;&gt;
        密码:&lt;input type=&quot;password&quot; name=&quot;password&quot;&gt;
        &lt;input type = &quot;hidden&quot; name = &quot;token&quot; value = &quot;{{.}}&quot;&gt;
        &lt;input type=&quot;submit&quot; value=&quot;登陆&quot;&gt;
    &lt;/form&gt;
    &lt;select name = &quot;fruit&quot;&gt;
    &lt;option value = &quot;apple&quot;&gt;apple&lt;/option&gt;
    &lt;option value = &quot;pear&quot;pear&lt;/option&gt;
    &lt;option value = &quot;banana&quot;&gt;banana&lt;/option&gt;
    &lt;/select&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</blockquote>
<p>注意将保存文件的格式设为UTF-8无BOM格式，否则可能由于编码问题，导致出错（直接显示页面HTML文件的内容）。<br>编写服务器端登陆处理代码：</p>
<pre><code>func login(w http.ResponseWriter, r *http.Request) {
    fmt.Println(&quot;method:&quot;, r.Method) //获取请求的方法
    if r.Method == &quot;GET&quot; {
        crutime := time.Now().Unix()
        h := md5.New()
        io.WriteString(h,strconv.FormatInt(crutime,10))
        token := fmt.Sprintf(&quot;%x&quot;,h.Sum(nil))

        t, _ := template.ParseFiles(&quot;login.gtpl&quot;)
        w.Header().Set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;)// fix the the return html file
        t.Execute(w, token)//增加 token：将nil 改为token            
        } else {
        //请求的是登陆数据，那么执行登陆的逻辑判断
        r.ParseForm()//默认handler 不对form进行解析   
        token := r.Form.Get(&quot;token&quot;)
        if token != &quot;&quot; {
            fmt.Println(&quot;token is :&quot;, template.HTMLEscapeString(r.Form.Get(&quot;token&quot;)))
        } else {
            fmt.Println(&quot;token  errer&quot;)
        }

        fmt.Println(&quot;username:&quot;, template.HTMLEscapeString(r.Form.Get(&quot;username&quot;)))
        fmt.Println(&quot;password:&quot;, template.HTMLEscapeString(r.Form.Get(&quot;password&quot;)))
        fmt.Println(&quot;fruit:&quot;,template.HTMLEscapeString(r.Form.Get(&quot;fruit&quot;)))

        if len(r.Form.Get(&quot;password&quot;)) == 0 {
            //template.HTMLEscape(w,[]byte(&quot;password is null&quot;))
            t, _ := template.ParseFiles(&quot;login.gtpl&quot;)
               w.Header().Set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;)
               t.Execute(w, nil)
        }else {
            t, _ := template.ParseFiles(&quot;upload.gtpl&quot;)//实现登陆后跳转到upload页面
            w.Header().Set(&quot;Content-Type&quot;, &quot;text/html; charset=utf-8&quot;)
               t.Execute(w, nil)
            template.HTMLEscape(w,[]byte(&quot;Hello &quot;+r.Form.Get(&quot;username&quot;)+&quot;,you have loginning,the web token is &quot;+template.HTMLEscapeString(r.Form.Get(&quot;token&quot;))))
        }
    }
}</code></pre>
<p>启动该页面的处理函数：</p>
<pre><code>func main() {
.............   
http.HandleFunc(&quot;/login&quot;, login)         //设置访问的路由
.............
err := http.ListenAndServe(&quot;:9090&quot;, nil) //设置监听的端口
if err != nil {
    log.Fatal(&quot;ListenAndServe: &quot;, err)
}</code></pre>
<p>浏览器输入127.0.0.1:9090,查看结果：<br><img src="http://i.imgur.com/LFJRDb4.png" alt=""></p>
<h2 id="-">文档上传</h2>
<p>Notepad++ 编写html文件并保存问upload.gtpl(以下github自动将html转换为网页显示)</p>
<blockquote>
<pre><code>&lt;html&gt;
&lt;head&gt;
&lt;title&gt;upload file&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;    
    &lt;form enctype =&quot;multipart/form-data&quot; action =&quot;http://127.0.0.1:9090/upload&quot; method = &quot;post&quot;&gt;
        &lt;input type = &quot;file&quot; name =&quot;uploadfile&quot;/&gt;
        &lt;input type = &quot;hidden&quot; name = &quot;token&quot; value =&quot;{{.}}&quot;/&gt;
        &lt;input type = &quot;submit&quot; value = &quot;upload&quot; /&gt;
        &lt;input type = &quot;hidden&quot; name = &quot;token&quot; value = &quot;{{.}}&quot;  
    &lt;/form&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</blockquote>
<p>注意将保存文件的格式设为UTF-8无BOM格式，否则可能由于编码问题，导致出错（直接显示页面HTML文件的内容）。<br>编写服务器端登陆处理代码：</p>
<pre><code>func upload (w http.ResponseWriter, r *http.Request) {//上传文件处理
    fmt.Println(&quot;method&quot;,r.Method)
    if r.Method == &quot;GET&quot; {
        crutime := time.Now().Unix()
        h := md5.New()
        io.WriteString(h,strconv.FormatInt(crutime,10))
        token := fmt.Sprintf(&quot;%x&quot;,h.Sum(nil))
        t, _ := template.ParseFiles(&quot;upload.gtpl&quot;)
        t.Execute(w,token)
    }else {
        r.ParseMultipartForm(32&lt;&lt;20)
        file, handler ,err := r.FormFile(&quot;uploadfile&quot;)        
        if err != nil {
            fmt.Println(err)
            return
        }

        defer file.Close()
        fmt.Fprintf(w,&quot;%v&quot;,handler.Header)

        f, err := os.OpenFile(&quot;./test/&quot;+handler.Filename,os.O_WRONLY|os.O_CREATE,0666)
        if err != nil {
            fmt.Println(err)
            return
        } else {
            fmt.Println(&quot;File:&quot;+handler.Filename+&quot; upload successfully&quot;)
        }
        defer f.Close()
        io.Copy(f,file)
    }
}</code></pre>
<p>启动该页面的处理函数：</p>
<pre><code>    func main() {
        .............   
        http.HandleFunc(&quot;/login&quot;, login)         //设置访问的路由
        .............
        http.HandleFunc(&quot;/upload&quot;,upload)//设置上传文件的访问路由
        err := http.ListenAndServe(&quot;:9090&quot;, nil) //设置监听的端口

        if err != nil {
            log.Fatal(&quot;ListenAndServe: &quot;, err)
        }</code></pre>
<p>浏览器输入127.0.0.1:9090,输入用户名，密码（密码不能为空）登陆后，页面跳转到upload 页面，选择本地文件点击上传，查看结果：<br><img src="http://i.imgur.com/oGM7gin.png" alt=""><br><img src="http://i.imgur.com/dW2Z3Rp.png" alt=""></p>
<p>整个执行过程服务端输出为：</p>
<pre><code>method: POST
token is : c405a0c1f62eaa856394b21462fafb2c
username: gouser
password: dkjssdfsdf
fruit: 
map[]
path /favicon.ico
scheme 
[]
method POST
File:Server.go upload successfully
map[]
path /favicon.ico
scheme 
[]</code></pre>
<p>源码获取：<img src="http://i.imgur.com/t4ps3Uh.png" alt=""><br><a href="https://github.com/swinghu/gowebserver.git" title="Go webserver"><a href="https://github.com/swinghu/gowebserver.git">https://github.com/swinghu/gowebserver.git</a></a></p>

</body>
</html>
<!-- This document was created with MarkdownPad, the Markdown editor for Windows (http://markdownpad.com) -->
